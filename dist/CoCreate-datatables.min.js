/* CoCreateJS */
var dtOBJs=[];function initSockets(){CoCreateSocket.listen("createDocument",function(e){createdDocument(e)}),CoCreateSocket.listen("deleteDocument",function(e){deletedDocument(e)}),CoCreateSocket.listen("updateDocument",function(e){updateTableData(e)}),CoCreateSocket.listen("readDocumentList",function(e){fetchedTableData(e)})}function initTables(e){let t=e||document;if(!t.querySelectorAll)return;let a=t.querySelectorAll("table[data-table_id]");0==a.length&&t!=document&&"TABLE"===t.tagName&&t.hasAttribute("data-table_id")&&(a=[t]);for(var l=0;l<a.length;l++){var n=a[l];if(!n.getAttribute("data-table_id"))continue;let e=g_cocreateFilter.setFilter(n,"data-table_id","datatable");if(e){var i=n.id;if(i&&""!=i&&!CoCreateUtils.getInitialized(n)){CoCreateUtils.setInitialized(n);var o=getAvailableOrders(i);console.log(o);var r=$("#"+i).DataTable({colReorder:!0,bScrollInfinite:!0,bScrollCollapse:!0,sScrollY:"calc(100vh - 105px)",scrollX:!0,paging:!1,searching:!1,ordering:!1,colReorder:!0,data:[],columns:getColumnDef(i,null),dom:"Bfrtip",buttons:["copyHtml5",{extend:"excelHtml5",exportOptions:{columns:":visible"}},"csvHtml5",{extend:"pdfHtml5",download:"open",exportOptions:{columns:":visible"}},"print","colvis",,{text:"Show",action:function(e,t,a,l){$(".colvis-menu").toggle()}}]});$("#"+i).on("click","td a",function(e){e.preventDefault(),CoCreateLogic.setLinkProcess(this)}),e.count||(e.count=30);var c={tableId:i,dataTable:r,collection:e.collection,availableOrders:o,availableMore:!0,state:"loaded",scrollTop:0,filter:e};dtOBJs.push(c),initializeShowHide(c),initializeTableOrder(c),initializeDTScroll(c),n.classList.contains("dt-selectable")&&initializeSelectableDT(c),n.addEventListener("changeFilterInput",function(e){initializeDatatable(c),fetchTableData(c)}),fetchTableData(c)}}}}function fetchTableData(e){e.availableMore&&"loading"!=e.state&&(g_cocreateFilter.fetchData(e.filter),e.state="loading")}function fetchedTableData(e){console.log(e);var t=e.element,a=g_cocreateFilter.getObjectByFilterId(dtOBJs,t);if(!a)return;const l=e.data;if(l.length>0){l.forEach(function(e){a.dataTable.row.add(e).draw(!1)});$("#"+a.tableId+"_wrapper .dataTables_scrollBody")}a.filter.startIndex=a.filter.startIndex+l.length,0==l.length&&(a.availableMore=!1),a.state="loaded"}function initializeDatatable(e){e.dataTable.clear().draw(!1),e.filter.startIndex=0,e.availableMore=!0}function initializeSelectableDT(e){$("#"+e.tableId+" tbody").on("click","tr .selectable",function(){$(this).closest("tr").toggleClass("tr-selected")})}function initializeShowHide(e){var t=e.tableId,a="[data-table_id='"+t+"'].colvis-menu";console.log(a);var l=document.querySelector(a);l&&($(l).hide(),$("#"+t+" thead th").each(function(e){var t='<li class="dropdown-item">\n              <input type="checkbox" data-name="\'+ title +\'" data-column="'+e+'" class="toggle-vis" checked>\n              <label >&nbsp;'+$(this).text()+"</label>\n            </li>";$(l).append(t)}),$(a+" .toggle-vis").on("click",function(t){var a=e.dataTable.column($(this).attr("data-column"));a.visible(!a.visible())}))}function initializeTableOrder(e){var t=document.querySelector("#"+e.tableId+"_wrapper");$(t).on("click","thead th",function(){var t=getIndex(this);console.log(t),e.filter.orders=getNewOrder(e,t),console.log(e.orders),initializeDatatable(e),fetchTableData(e)})}function getIndex(e){for(var t=0;null!=(e=e.previousSibling);)t++;return t}function getNewOrder(e,t){var a=e.availableOrders[t],l=e.filter.orders[0];return[l&&l.name==a&&-1==l.type?{name:a,type:1}:{name:a,type:-1}]}function getAvailableOrders(e){for(var t=[],a=getTableTemplate(e).querySelectorAll("td"),l=0;l<a.length;l++){for(var n="",i=a[l].querySelectorAll("h1, h2, h3, h4, h5, h6, p, i, q, a, b, li, span, code"),o=0;o<i.length;o++){var r=i[o].getAttribute("name");""==n&&r&&(n=r)}t.push(n)}return t}function updateTableData(e){for(var t=0;t<dtOBJs.length;t++){var a=dtOBJs[t];a.collection==e.collection&&a.dataTable.rows().every(function(){var t=this.data();this.id();if(t._id==e.document_id){for(var a in e.data)t[a]=e.data[a];this.data(t).draw(!1)}})}}function createdDocument(e){const t=e.collection;e.element;let a=e.data;for(var l=0;l<dtOBJs.length;l++){var n=dtOBJs[l];n.collection==t&&(n.dataTable.row.add(a).draw(!1),n.filter.startIndex=n.filter.startIndex+1)}}function deletedDocument(e){for(var t=e.collection,a=e.document_id,l=0;l<dtOBJs.length;l++){var n=dtOBJs[l];n.collection==t&&n.dataTable.rows().every(function(){var e=this.data();e&&e._id==a&&(this.remove().draw(!1),n.filter.startIndex=n.filter.startIndex-1)})}}function initializeDTScroll(e){var t=e.tableId,a=$("#"+t+"_wrapper .dataTables_scrollBody"),l=a.find("#"+t);a&&l&&a.on("scroll",function(){Math.abs(l.outerHeight()-a.height()-a.scrollTop())<3&&0!=a.scrollTop()&&(console.log("load more data"),e.scrollTop=a.scrollTop(),fetchTableData(e))})}function getColumnDef(e,t){for(var a=[],l=getTableTemplate(e).querySelectorAll("td"),n=0;n<l.length;n++){var i=getColumn(l[n],t);a.push(i)}return a}function getIdColumn(){var e=new Object;return e.data=null,e.render=function(e,t,a,l){return"<span>"+e._id+"</span>"},e}function getColumn(e,t){var a=new Object;return a.className=e.getAttribute("class"),a.data=null,a.render=function(t,a,l,n){for(var i=e.cloneNode(!0),o=i.querySelectorAll("h1, h2, h3, h4, h5, h6, p, i, q, a, b, li, span, code"),r=0;r<o.length;r++){var c=o[r],d=c.getAttribute("name");for(var s in t)s==d&&(c.innerHTML=t[s]);if("document_id"==d&&(c.innerHTML=t._id),"created_on"==d&&t.created_on){var u=new Date(t.created_at);c.innerHTML=u.toISOString()}if("updated_on"==d&&t.updated_on){u=new Date(t.updated_at);c.innerHTML=u.toISOString()}}var b=i.querySelectorAll("a");for(r=0;r<b.length;r++){b[r].setAttribute("data-pass_document_id",t._id)}var f=i.querySelector(".named-avatar");if(f){var g=f.getAttribute("data-avatar_name"),v=f.getAttribute("data-avatar_image"),h=!1;if(v)for(var s in t)if(s==v&&""!=t[s]){var p=document.createElement("img");p.src=t[s],f.innerHTML="",f.appendChild(p),h=!0}if(!h&&g)for(var s in t)s==g&&(f.innerHTML=t[s].substr(0,1).toUpperCase(),h=!0)}return i.innerHTML},a}function getTableTemplate(e){var t=document.getElementById(e);return!!t&&t.querySelector("tbody").querySelector("tr.template")}function initDatatables(){$("#example tfoot th").each(function(e){var t=$(this).text();$(".dropdown-menu").append('<li class="dropdown-item">                    <input type="checkbox" data-name="'+t+'" data-column="'+e+'" class="toggle-vis" checked="true">                    <label >&nbsp;'+t+"</label>            </li>"),$(this).html('<input type="text" class="advance_search" placeholder="Search '+t+'" />')}),table=$("#example").DataTable({colReorder:!0,scrollY:"calc(100vh - 300px)",scrollX:!0,paging:!1,dom:"Bfrtip",buttons:["copyHtml5",{extend:"excelHtml5",exportOptions:{columns:":visible"}},"csvHtml5",{extend:"pdfHtml5",download:"open",exportOptions:{columns:[0,1,2,5,6]}},"print",{text:"Search",action:function(e,t,a,l){$(".advance_search").toggleClass("d-none")}},"colvis",{text:"Show",action:function(e,t,a,l){$(".dropdown-menu").toggle()}}]}),$(".advance_search").toggleClass("d-none"),$(".toggle-vis").on("click",function(e){var t=table.column($(this).attr("data-column"));t.visible(!t.visible())}),table.columns().every(function(){var e=this;$("input",this.footer()).on("keyup change",function(){e.search()!==this.value&&e.search(this.value).draw()})})}function initTableButtons(){for(var e=document.querySelectorAll("[data-table_id][data-btn_type]"),t=0;t<e.length;t++){var a=e[t];a.getAttribute("data-btn_type"),a.getAttribute("data-table_id");a.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("data-btn_type");tableBtnClicked(this.getAttribute("data-table_id"),t)})}}function tableBtnClicked(e,t){if(e)for(var a=0;a<dtOBJs.length;a++){var l=dtOBJs[a];if(l.tableId==e){var n=l.dataTable;switch(t){case"copy":n.button(0).trigger();break;case"excel":n.button(1).trigger();break;case"csv":n.button(2).trigger();break;case"pdf":n.button(3).trigger();break;case"print":n.button(4).trigger();break;case"column-visibility":n.button(6).trigger();break;case"delete-rows":deleteSelectedRows(l)}}}}function deleteSelectedRows(e){let t=[],a=e.dataTable.rows(".tr-selected").data(),l=a.length;for(let n=0;n<l;n++)t.push(a[n]._id),CoCreate.deleteDocument({collection:e.collection,document_id:a[n]._id,metadata:""})}document.addEventListener("DOMContentLoaded",function(){initSockets(),initTableButtons(),initTables()}),CoCreateInit.register("CoCreateDatatable",window,initTables);